<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Juan Antonio Nepormoseno Rosales" />
  <title>Turning bloated mobile interfaces into CLIs</title>
  <link rel="stylesheet" type="text/css" href="file:///home/edearth/dev/newpage//edearth.css" />
</head>
<body>
<div class="header">
  <img class="my-photo" src="https://edearth.github.io/imgs/myface.jpg">
  <div class="my-description">
    <h1>Juan Antonio Nepormoseno</h1>
    <p>A spanish developer and tester writing about technology, games, cooking and my life philosophy.</p>
    <div class="menu icon-tray">
      <a class="menu-button" href="https://github.com/edearth/">
        <img class="menu-icon" src="https://edearth.github.io/imgs/icon-github.png"/>
      </a>
      <a class="menu-button" href="https://twitter.com/JNepormoseno">
        <img class="menu-icon" src="https://edearth.github.io/imgs/icon-twitter.png"/>
      </a>
      <a class="menu-button" href="https://www.linkedin.com/in/juan-antonio-nepormoseno-rosales-76b621127/">
        <img class="menu-icon" src="https://edearth.github.io/imgs/icon-linkedin.png"/>
      </a>
    </div>
    <div class="menu">
      <ul>
        <li class="menu-button tech-highlight"><a href="#">Tech</a></li>
        <li class="menu-button cook-highlight"><a href="#">Food</a></li>
        <li class="menu-button game-highlight"><a href="#">Life</a></li>
      </ul>
    </div>
  </div>
</div>
<br><br>
  <div class="feed">
    <article class="container">
      <div class="title tech-highlight">
        <h1>&gt; Turning bloated mobile interfaces into CLIs</h1>
      </div>
      <p class="title-date">2020-09-14</p>
      <div class="content"><p>Say, have you ever tried that “new cool app” but it lacked some feature that would’ve really sold it to you? Perhaps you didn’t understand the UI? Is that even your fault? Maybe your phone even struggled to run it because it’s really poorly optimized. And that download size… omg, it’s taking up how much space!?</p>
<p>Wouldn’t it be nice to extend or improve that app? Well, with it being closed source as it is that might be an utopian dream, but we might still have a chance at making our lives easier by reverse engineering it and consuming its API directly.</p>
<h2 id="overview">Overview</h2>
<p>What we are going to do is force an Android emulator to send all its network traffic through us. Then, we will trick it into thinking we are the server it’s trying to reach and that it can trust us. This way, we will be able to understand the encrypted HTTPS messages the app sends and receives. This is what is known as a <strong>“Man in the Middle attack”</strong> in cybersecurity (MITM from now on).</p>
<p>[Drawing of man in the middle]</p>
<p>When we are able to understand what app and backend are saying to each other, we will begin investigating the (now exposed) API. When we’re done, we might even have the chance to automate our daily app usage into a script. That way we won’t even have to open the app again.</p>
<p>This article will be split in 3 parts:</p>
<ul>
<li>Setting up the tools and emulator</li>
<li>Configuring the MITM proxy</li>
<li>Investigating the API and automating</li>
</ul>
<h2 id="setting-up-emulator-and-app">Setting up emulator and app</h2>
<h3 id="install-the-tools">Install the tools</h3>
<p>If you don’t have the Android platform tools, we will install them now. I’m using Arch, so I will use these AUR packages:</p>
<ul>
<li>https://aur.archlinux.org/android-sdk.git</li>
<li>https://aur.archlinux.org/android-sdk-platform-tools.git</li>
</ul>
<p>You can install them like</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="fu">git</span> clone https://aur.archlinux.org/android-sdk.git</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="bu">cd</span> android-sdk</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="ex">makepkg</span> -si</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="bu">cd</span> ..</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="fu">git</span> clone https://aur.archlinux.org/android-sdk-platform-tools.git</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="bu">cd</span> android-sdk-platform-tools</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="ex">makepkg</span> -si</span></code></pre></div>
<p>It shouldn’t be too difficult to find out how to install them on another platform. For instance, if you’re on Ubuntu, you can just do:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt install android-sdk</span></code></pre></div>
<p>On Mac (assuming you have Brew installed):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ex">brew</span> tap caskroom/cask</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="ex">brew</span> cask install android-sdk</span></code></pre></div>
<h3 id="install-the-system-image">Install the system image</h3>
<p>Once we have the tools we need, we can download the system image. Since we want to download an app from the Play Store, we will need that the image we use includes the Google API and the Play Store. We want to find a an image containing “google_apis_playstore”. I chose the “android-25” one (Android 9), but you can choose another one if you want.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="ex">sdkmanager</span> --list <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;google_apis_playstore&quot;</span> <span class="co">#select another image from this list if you want</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="fu">sudo</span> sdkmanager --install <span class="st">&quot;system-images;android-25;google_apis_playstore;x86&quot;</span> </span></code></pre></div>
<h3 id="create-the-avd">Create the AVD</h3>
<p>After accepting the license and waiting for the download to finish, we can finally create our AVD.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ex">avdmanager</span> create avd --name <span class="st">&quot;mitm-emulator&quot;</span> --package <span class="st">&quot;system-images;android-25;google_apis_playstore;x86&quot;</span></span></code></pre></div>
<p>And open it with:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="ex">emulator</span> -avd mitm-emulator <span class="kw">&amp;</span></span></code></pre></div>
<h3 id="install-the-target-app">Install the target app</h3>
<p>This should be the easiest step. Just login to the Play Store and download your target app.</p>
<p>Make sure you can open it before proceeding.</p>
<h2 id="setting-up-the-proxy">Setting up the proxy</h2>
<h3 id="install-mitm-proxy">Install MITM proxy</h3>
<p>Now we will install and configure our proxy. We will be using <strong><a href="https://mitmproxy.org">mitmproxy</a></strong>, an MIT licensed open source tool built just for this.</p>
<p>It can easily be installed in Arch with:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="ex">pacman</span> -Sy mitmproxy</span></code></pre></div>
<p>It seems like on Ubuntu you will need to install pip and then install mitmproxy using pip.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="fu">sudo</span> apt install python3-pip</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="fu">sudo</span> pip3 install mitmproxy</span></code></pre></div>
<p>On Mac, just use brew:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="ex">brew</span> install mitmproxy</span></code></pre></div>
<p>To test it out, let’s start the emulator and open its settings by clicking on the 3 dots button. Then, navigate to the <strong>settings</strong> section, select the <strong>Proxy tab</strong> and configure to use <code>http://0.0.0.0:8080</code> as a proxy, like in the image below.</p>
<p><img src="file:///home/edearth/dev/newpage//imgs/reveng/emulator_proxy_config.png" /></p>
<p>Run mitmproxy with no arguments, like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="ex">mitmproxy</span></span></code></pre></div>
<p>We can now go back to the emulator and navigate anywhere. You will see it’s almost as if your device lost connection, and if you try to use a web browser, a warning about your connection not being private will appear.</p>
<p><img src="file:///home/edearth/dev/newpage//imgs/reveng/mitm_no_cert00.png" height="400" /></p>
<p>This happens because mitmproxy signs HTTPS traffic with its own certificate. Since the emulator doesn’t trust that certificate, it won’t even accept that response! If you go to the terminal where you launched mitmproxy, you should see something like this. Notice all the traffic is HTTP, there are no HTTPS messages.</p>
<p><img src="file:///home/edearth/dev/newpage//imgs/reveng/mitm_no_cert01.png" /></p>
<p><img src="file:///home/edearth/dev/newpage//imgs/reveng/mitm_no_cert02.png" /></p>
<p>To continue, we will need to make the emulator trust mitmproxy’s Certificate Authority.</p>
<h3 id="install-the-certificate-authority">Install the Certificate Authority</h3>
<p>The way mitmproxy works is it has its own Certificate Authority. It uses it to generate certificates on the fly for whatever external resource the emulator asks for. It then uses those certificates to encrypt the messages sent to it, making it seem like the emulator is talking with the real server. In reality, though, it is decrypting and encrypting all the messages, so it knows <strong>everything</strong> the client and server are talking about. And neither of them knows it is spying on them.</p>
<p>If you read the documention for mitmproxy you will see there are official instructions on how to install the certificate on mobile devices: you visit “<code>mitm.it</code>” in the browser, download the certificate and install it. Then you can see HTTPS traffic normally… but just in the browser.</p>
<p>If we want to read HTTPS traffic from native apps, we need to install itas a <strong>system certificate</strong>. We will need root privileges for that. So we will launch the emulator specifying:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="ex">emulator</span> -avd test-proxy -writable-system <span class="kw">&amp;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="ex">adb</span> root</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="ex">adb</span> remount</span></code></pre></div>
<p>Now we need to find our certificate file. If you are using Linux, it will be in the <code>~/.mitmproxy/</code> folder. Let’s save it to a variable named “CA”:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="va">CA=</span><span class="st">&quot;~/.mitmproxy/mitmproxy-ca-cert.pem&quot;</span></span></code></pre></div>
<p>We just need to copy that file into the emulator’s trusted CAs folder, but it needs to be named with a special value. The filename must be the hash of the certificate itself. You can calculate it with the following command:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="va">HASH=$(</span><span class="ex">openssl</span> x509 -noout -subject_hash_old -in <span class="st">&quot;</span><span class="va">$CA</span><span class="st">&quot;</span><span class="va">)</span></span></code></pre></div>
<p>But since mitmproxy uses the same default certificate everywhere, we know the value should be <code>c8750f0d</code>, so you can skip this step and just use that value. You can always come back and recalculate the value if it does not work 😛</p>
<p>So you can just do:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="ex">adb</span> push <span class="st">&quot;</span><span class="va">$CA</span><span class="st">&quot;</span> /system/etc/security/cacerts/c8750f0d.0</span></code></pre></div>
<p>If you try to load a website now, it should load correctly and you should see traffic being detected by mitmproxy. Moreover, if you try to open the target app, you should see its traffic too! Congratulations!</p>
<p>Don’t forget to unroot the device before proceeding.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="ex">adb</span> unroot</span></code></pre></div>
<p>[NOTE: CONTINUE FROM HERE!!!] [NOTE: CONTINUE FROM HERE!!!] [NOTE: CONTINUE FROM HERE!!!] [NOTE: CONTINUE FROM HERE!!!] [NOTE: CONTINUE FROM HERE!!!]</p>
<h2 id="exploitation">Exploitation</h2>
<h3 id="investigating-the-api">Investigating the API</h3>
<p>Use app See what appears in mitmproxy If you’re lucky, it will use json instead of protobuf.</p>
<p>enter <code>w</code> you will enter export mode. If you then type <code>export.clip curl @focus</code> to copy curl request to clipboard</p>
<h3 id="automating-queries">Automating queries</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="ex">curl</span> asdasdasdasd <span class="op">&gt;</span> coso</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="fu">cat</span> coso <span class="kw">|</span> <span class="ex">jq</span> <span class="st">&#39;.groupings[].discover_bucket.items[]&#39;</span> <span class="kw">\</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a><span class="kw">|</span> <span class="ex">jq</span> <span class="st">&#39;select(.distance &lt; 1)&#39;</span> #filter out stores further than 1 km away</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="kw">|</span> <span class="ex">jq</span> <span class="st">&#39;select(.item.item_category != &quot;BAKED_GOODS&quot;)&#39;</span> #filter out unwanted store categories</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a><span class="kw">|</span> <span class="ex">jq</span> <span class="st">&#39;(.store.store_name +</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a><span class="st">    &quot; // € &quot; + (.item.price.minor_units/100 | tostring) +</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a><span class="st">    &quot; // &quot;+ .pickup_interval.start)&#39;</span> # print only the wanted data</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a><span class="kw">|</span> <span class="fu">sort</span> <span class="kw">|</span> <span class="fu">uniq</span> <span class="co"># show only unique results</span></span></code></pre></div>
<h2 id="end-and-thanks">End and thanks</h2>
<p>This article is just an amalgamation of information I found online. I would like to thank the writers of those articles.</p>
<p>If you want to know more about this topic, I encourage you to follow these links and search for more information.</p>
<ul>
<li>Export curl from mitmproxy, Marc Betts (2019 Jul 20): [https://howdoitestthat.com/export-curl-from-mitm-proxy/]</li>
<li>Setting up mitmproxy for Android emulator, Jonathan Lipps (2019 Apr 3): [https://appiumpro.com/editions/63-capturing-android-emulator-network-traffic-with-appium]</li>
<li>Installing Open GApps, Daishi Kato (2017 Mar 6): <span class="citation" data-cites="dai_shi/installing-google-play-services-on-an-android-studio-emulator-fffceb2c28a1">[https://medium.com/@dai_shi/installing-google-play-services-on-an-android-studio-emulator-fffceb2c28a1]</span></li>
<li>Why you need a Google API image, “oenpelli” on StackOverflow (2014 Jul 18): [https://stackoverflow.com/a/24817495]</li>
</ul>
<p>// Ideas ; ; In my case, this app has random offers and I want to find the nearest.</p>
<h3 id="deprecated-since-you-can-download-a-system-image-with-play-store-installing-google-play">(deprecated since you can download a system image with Play Store :/) Installing Google Play</h3>
<p>Download the Open GApps file for your system image from [https://opengapps.org/]. You can extract it with:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="fu">unzip</span> open_gapps-x86_64-6.0-pico-20170304.zip <span class="st">&#39;Core/*&#39;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="fu">rm</span> Core/setup*</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="ex">lzip</span> -d Core/*.lz</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a><span class="kw">for</span> <span class="ex">f</span> in <span class="va">$(</span><span class="fu">ls</span> Core/*.tar<span class="va">)</span><span class="kw">;</span> <span class="kw">do</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a>  <span class="fu">tar</span> -x --strip-components 2 -f <span class="va">$f</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a><span class="kw">done</span></span></code></pre></div>
<p>Then run an emulator and install the packages:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="ex">emulator</span> @android6 -writable-system <span class="kw">&amp;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="co"># wait for emulator to load</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a><span class="ex">adb</span> remount</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a><span class="ex">adb</span> push etc /system</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a><span class="ex">adb</span> push framework /system</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a><span class="ex">adb</span> push app /system</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a><span class="ex">adb</span> push priv-app /system</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a><span class="co"># restart</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a><span class="ex">adb</span> shell stop</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a><span class="ex">adb</span> shell start</span></code></pre></div>
<p>-Now you can open the Play Store, log in and install the target app normally.</p></div>
    </article>
  </div>
</body>
</html>
